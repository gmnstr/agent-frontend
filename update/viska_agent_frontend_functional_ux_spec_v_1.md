# Viska Agent Frontend — Functional & UX Spec (v1)

Version: 1.0  
Owner: Product + Platform  
Scope: Functional/UX behaviors for the agent portal. Visual design is out of scope and will be generated by a separate system. This spec binds to the brand/doc concepts (Router, Critic, State Capsule, Evidence Bundle, Impact Ledger, ToolGraph Plan, Trust Pack).

---

## 0. Goals & Non‑goals
**Goals**
- Provide a clear, low‑friction UI to create, track, verify, and replay agent tasks.  
- Surface the **proof surface** (plan hash, critic verdicts, receipts chain) in one glance.  
- Make **evidence bundles** downloadable and self‑verifiable.  
- Keep the UI fast with large diffs/logs (virtualization + lazy fetch).

**Non‑goals**
- Visual styling/brand theming (handled by separate design pass).  
- Model selection UX beyond lane/router predicates (advanced labs UI deferred).

---

## 1. Information Architecture
Top nav: **Overview** · **Tasks** · **Environments** · **Docs** (external)  
Brand lockup: Viska symbol + wordmark (top‑left).  
Global elements: command palette (⌘/Ctrl‑K), user menu, theme switch, search.

### 1.1 Overview
A high‑level dashboard of task volume and state, with a status mix and spark stats.
- **Widgets**: Active Tasks count, Status Mix (Open/Running/Merged/Failed/Archived), Recent activity stream (last 24h).  
- Clickthroughs to filtered **Tasks** view.

### 1.2 Tasks (index)
A searchable, filterable list of tasks across repos and environments.
- **Controls**: search box (title, repo, summary), status chips (Open/Running/Merged/Failed/Archived), repo filter, environment filter, date range, owner.  
- **List item** shows: title, age, repo, brief summary line, status pill, score deltas if any, live‑update dot.  
- **Empty state**: show “Create task” affordance.

### 1.3 Task detail
A collapsible, sectioned view focused on **proof surface** first.
- **Header**: task id, repo, branch, PR link (if any), environment, status, owner, last updated, actions (Share, Archive, View PR).  
- **Proof Surface (always visible)**:  
  - **Plan hash** (sha256) + signer badge.  
  - **Receipt** summary (last idx, chain OK/ERROR).  
  - **Critic verdict** (All suites passing / N failing) with link to failing critic sections.  
  - **State Capsule diff** summary (click to expand diff).  
  - Primary actions: **Download trust pack**, **Verify locally** (copy‑snippet), **Replay run**.
- **Diff tab**: virtualized file tree left; selected file diff right (side‑by‑side or unified).  
- **Logs tab**: streaming logs with pause, tail, severity filter, search.  
- **Receipts tab**: chain viewer with idx, ts, sha256_prev, sha256_entry, signer, type, ref (virtualized table).  
- **Plan tab**: ToolGraph plan (read‑only JSON tree) with signed metadata.  
- **Evidence tab**: critic reports, verifier logs, policy decisions (downloadable artifacts).  
- **Discussion**: lightweight comment thread (optional; MVP can defer).

### 1.4 Environments
A table of connected workspaces/environments with health/status.
- Columns: Name, Repository (or scope), Active tasks, Owner, Created, Health (Healthy/Degraded/Offline), Last sync, Actions (menu).  
- Row click: environment detail (task subset, health, last sync diagnostics).

### 1.5 Docs (external)
Links out to verification instructions and API docs, plus sample **trust pack**.

---

## 2. Primary Flows

### 2.1 Create task (from Overview or Tasks)
1) User enters mission text, optionally attaches repo/branch/context.  
2) Backend synthesizes a **ToolGraph plan** (hash + signature) and opens a new task.  
3) User can **Ask** (clarify/scope) or **Code** (execute).  
4) Task runs; live updates stream to list item and detail view.  
5) On completion: critic verdicts, receipts chain, evidence bundle are attached.

### 2.2 Review and verify a task
1) Open Task detail → **Proof Surface** at top.  
2) Download **trust pack**.  
3) Click **Verify locally** → copy a ready command (e.g., `viska-verify trust-pack.zip`).  
4) (Optional) **Replay run** using the same plan hash; show matched outputs and receipts.

### 2.3 Investigate failures
1) Proof Surface shows failing critics; click to jump to Evidence/Logs.  
2) Diff tab shows file changes; Logs tab filtered to errors.  
3) User requests a fix via **Ask**; system proposes a patch gated by critics.  
4) New receipts entries appended; chain integrity visible in **Receipts** tab.

### 2.4 Environment triage
1) Open Environments → find **Degraded/Offline** rows.  
2) Click row → diagnostics (last sync, failing hooks).  
3) CTA: resync, pause, or unlink (permissions gated).

---

## 3. Data Models (frontend contracts)

### 3.1 Task
```json
{
  "id": "task-123",
  "title": "Improve diff rendering performance",
  "repo": "org/repo",
  "branch": "feature/xyz",
  "status": "open|running|merged|failed|archived",
  "owner": { "id": "u1", "name": "A. User" },
  "createdAt": "2025-09-22T18:42:00Z",
  "updatedAt": "2025-09-22T19:12:00Z",
  "plan": { "hash": "sha256:...", "signer": "viska@...", "url": "/api/tasks/123/plan" },
  "receipts": { "count": 91, "chain_ok": true, "url": "/api/tasks/123/receipts" },
  "critics": { "total": 14, "failing": 0, "summary": "All suites passing" },
  "stateCapsule": { "hasDiff": true, "url": "/api/tasks/123/state" },
  "evidenceBundleUrl": "/api/tasks/123/trust-pack",
  "pr": { "url": "https://...", "number": 42 },
  "environmentId": "env-001",
  "summary": "Implements virtualization and chunked syntax highlighting."
}
```

### 3.2 Environment
```json
{
  "id": "env-001",
  "name": "Docs preview stack",
  "repo": "org/portal-ui",
  "activeTasks": 20,
  "owner": "Aria Chen",
  "createdAt": "2025-09-01T12:00:00Z",
  "health": "healthy|degraded|offline",
  "lastSync": "2025-09-22T19:55:00Z"
}
```

### 3.3 Receipt entry (virtualized table)
```json
{
  "idx": 90,
  "ts": "2025-09-22T19:10:25Z",
  "sha256_prev": "...",
  "sha256_entry": "...",
  "signer": "viska@runtime",
  "type": "plan|exec|critic|artifact",
  "ref": "evidence/critic-12.json"
}
```

---

## 4. Screens & Components (behavioral spec)

### 4.1 Mission input (Overview)
- Multiline input with history; supports attachments (repo/branch/plan.json).  
- Buttons: **Ask** (open AI chat side‑panel), **Code** (execute plan).  
- Keyboard: Enter=Ask, ⌘/Ctrl‑Enter=Code.  
- After submit: redirect to **Task detail**; keep a toast with link.

### 4.2 Task list
- Infinite scroll (virtualized).  
- Live status updates via SSE/WebSocket; list items diff color only on change for 2s.  
- Filters persist per user.  
- Quick actions on hover: **Share**, **Archive**.

### 4.3 Proof Surface (Task detail)
- Sticky, collapsible card at top.  
- **Plan** shows hash, signer, copy button, and small badge if signature verified.  
- **Critics** show pass/fail chips; clicking a failing chip filters Evidence.  
- **Receipts** shows chain status and last idx; click opens Receipts tab.  
- **State Capsule** shows a compact diff count; click opens JSON diff viewer.  
- Primary buttons: **Download trust pack**, **Verify locally** (copies command), **Replay run**.

### 4.4 Diff viewer
- Modes: side‑by‑side or unified; large‑file virtualization; syntax highlighting.  
- File tree: keyboard navigation, search, expand/collapse all.  
- Copy‑patch button for selected file hunk.

### 4.5 Logs viewer
- Live stream; pause/resume; follow tail toggle; severity filter; search.  
- Copy selection; download logs; jump to time.

### 4.6 Receipts viewer
- Virtualized table; chain integrity indicator; row details drawer (raw JSON).  
- Export selected rows as JSONL.

### 4.7 Plan viewer
- Read‑only JSON tree; signature badge; copy plan; download plan.json.

### 4.8 Evidence viewer
- List of artifacts grouped by critic; each row shows name, size, type, status.  
- Download single artifact or all (zip).  
- Optional inline viewer for JSON, text, images.

### 4.9 Environments
- Paginated/virtualized table with health badges; row click → details.  
- Actions menu (permission‑gated): resync, pause, unlink.  
- Detail page: recent tasks, last sync logs, configuration summary.

---

## 5. Trust Pack (download & verify) — UX
- **Download** button always visible on Task detail.  
- Post‑download tip shows exact CLI verify command and checksum.  
- Verification snippet references: manifest signature → plan signature → receipt chain → evidence pointers.  
- If verification fails, UI suggests artifacts to inspect and opens Evidence tab filtered to relevant critic/log entries.

---

## 6. Permissions & Roles (MVP)
- **Viewer**: read‑only across Tasks/Environments; download trust packs.  
- **Operator**: create tasks, replay runs, resync environments.  
- **Admin**: manage environments and retention settings.

---

## 7. Performance, A11y, i18n
- Virtualize large lists (diffs, logs, receipts).  
- All controls keyboard accessible; WCAG AA contrast on dark.  
- Language strings externalized; English default; Swedish-ready.

---

## 8. Error States & Empty States
- **No tasks found**: suggest creating a task; show example prompts.  
- **Receipts chain error**: red banner with repair hints; link to last good idx.  
- **Downloading trust pack fails**: retry; show curl fallback.  
- **Environment offline**: callout with “last healthy” timestamp and docs link.

---

## 9. Telemetry & Audit
- Client events: create_task, run_started, run_finished, critic_fail, bundle_downloaded, verify_snippet_copied, replay_clicked.  
- **Impact Ledger** integration: each UI action that mutates state should emit a signed receipt; read‑only views emit analytics only.

---

## 10. Navigation & Routing
- Shallow routes: `/overview`, `/tasks`, `/tasks/:id`, `/environments`, `/environments/:id`.  
- Preserve filters in query params.  
- On reconnect, resume live updates without reloading.

---

## 11. Content & Microcopy (tone)
- Calm, precise, evidence‑first.  
- Prefer verbs like **Verify**, **Replay**, **Download evidence** over marketing fluff.  
- Avoid absolute claims.

---

## 12. Acceptance Criteria (MVP)
- A user can create a task, watch it run, and download a trust pack.  
- Task detail shows plan hash, critic verdict, and receipts chain without scrolling on a 1440×900 viewport.  
- Verification snippet copies to clipboard and works offline with the sample pack.  
- Receipts table remains responsive with 50k entries.

---

## 13. Out‑of‑scope (future)
- Advanced router/lanes editor.  
- Full PR review and merge from inside the portal.  
- Deep environment provisioning UI.

---

## 14. Glossary (canonical)
Router · Critic · State Capsule · Evidence Bundle · Impact Ledger · ToolGraph Plan · Trust Pack · Proof Surface.

